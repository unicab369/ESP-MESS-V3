<!DOCTYPE html>
<html>
<head>
	<title>ESP32 Files Explorer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../lib/uplot/dist/uPlot.min.css">
	<link rel="stylesheet" href="../lib/w3.css">
	<link rel="stylesheet" href="page-style.css">
</head>
<body>
	<div class="dashboard">
		<div class="header">
			<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
				<a href="../page-sensors-scan/sensors-scan.html">
					<button style="padding: 8px 12px; background: #f0f0f0; border: none; 
									border-radius: 6px; cursor: pointer;">
						â† Back
					</button>
				</a>
				<h1 style="margin: 0;"> ğŸ“‚ Files Explorer</h1>
			</div>

			<p>Scan for sensors</p>
			
			<div class="status-bar">
				<div class="status-item">
					<div>ESP32 IP</div>
					<div id="espIp">Connecting...</div>
				</div>
				<div class="status-item">
					<div>Scan</div>
					<div id="scan-count">---</div>
				</div>
			</div>
			
			<div class="input-group">
				<input type="text" id="serverIp" placeholder="ESP32 IP Address" value="10.0.0.188">
				<button class="btn" onclick="connectToServer()">Connect</button>
			</div>
		</div>

		<div id="charts-container" style="width: 100%;"></div>

		<div class="chart-card">
			<div class="chart-title">ğŸ“‹ Scan Results</div>
			
			<div style="margin-bottom: 15px; display: flex; gap: 20px; font-size: 18px; color: blue;">
				<a href="#" onclick="loadEntry()">/log</a>
				<a href="#" onclick="loadEntry()">/nvs</a>
				<a href="#" onclick="loadEntry('litFS')">/littleFS</a>
			</div>

			<div id="list-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; 
									border-radius: 8px; padding: 10px; margin-bottom: 15px; background: lightgray;">
				<div style="text-align: center; padding: 20px; color: #666;">
					No File found
				</div>
			</div>
			
			<div id="item-container" style="display: flex; justify-content: space-between; margin-bottom: 15px;"></div>

			<!-- <div style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;">
				<button class="btn" onclick="startScan()">ğŸ”„ Refresh</button>
			</div> -->
		</div>
	</div>

	<!-- scripts -->
	<script src="../scripts/RequestScheduler.js"></script>
	<script src="../scripts/RequestServices.js"></script>
	<!-- <script src="page-script.js"></script> -->

	<script>
		var entries = []

		function backEntry() {
			entries.pop()
			loadEntry(entries.pop())
		}

		function loadEntry(sub_entry = '') {
			entries.push(sub_entry)
			console.log("entries", entries)

			service_getFiles(sub_entry, (result) => {
				let html = /*html*/
					`
						<div onclick="backEntry()" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; gap: 10px;">
							<div>â¬…ï¸ Back</div>
						</div>
					`

				const is_text = sub_entry.toUpperCase().includes('.TXT')

				if (is_text) {
					html += /*html*/
						`
							<div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; gap: 10px;">
								<div style="white-space: pre-wrap;">${result}</div>
							</div>
						`
				}
				else {
					if (sub_entry.length < 1) html += ``
					
					// Sort folders first
					const sorted = result.sort((a, b) => {
						const aIsFolder = !a.includes('.')
						const bIsFolder = !b.includes('.')
						
						// If one is folder and other isn't, folder comes first
						if (aIsFolder && !bIsFolder) return -1
						if (!aIsFolder && bIsFolder) return 1
						
						// Both are same type, sort alphabetically
						return a.localeCompare(b)
					})

					// Update UI
					if (sorted.length === 0) {
						html += '<div style="text-align: center; padding: 20px; color: #666;">No Files found</div>';
					} else {
						sorted.forEach((item, index) => {
							const prefix = item.includes('.') ? 'ğŸ“„' : 'ğŸ“';
							html += /*html*/
								`
									<div onclick="loadEntry('${item}')" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; gap: 10px;">
										<div>${prefix} ${item}</div>
									</div>
								`
						})
					}
				}
				
				document.getElementById('list-container').innerHTML = html
			})
		}

		// Initialize on page load
		window.addEventListener('DOMContentLoaded', async function() {
			loadEntry('')
		});
		
		function closeModal() {
			document.body.removeChild(document.getElementById('overlay-container'));
			window.confirm3 = null;
		}
	</script>
</body>
</html>
