<!DOCTYPE html>
<html>
<head>
	<title>ESP32 Files Explorer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../lib/uplot/dist/uPlot.min.css">
	<link rel="stylesheet" href="../lib/w3.css">
	<link rel="stylesheet" href="page-style.css">
</head>
<body>
	<div class="dashboard">
		<div class="header">
			<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
				<a href="../page-sensors-scan/sensors-scan.html">
					<button style="padding: 8px 12px; background: #f0f0f0; border: none; 
									border-radius: 6px; cursor: pointer;">
						‚Üê Back
					</button>
				</a>
				<h1 style="margin: 0;"> üìÇ Files Explorer</h1>
			</div>

			<p>Scan for sensors</p>
			
			<div class="status-bar">
				<div class="status-item">
					<div>ESP32 IP</div>
					<div id="espIp">Connecting...</div>
				</div>
				<div class="status-item">
					<div>Scan</div>
					<div id="scan-count">---</div>
				</div>
			</div>
			
			<div class="input-group">
				<input type="text" id="serverIp" placeholder="ESP32 IP Address" value="10.0.0.188">
				<button class="btn" onclick="connectToServer()">Connect</button>
			</div>
		</div>

		<div id="charts-container" style="width: 100%;"></div>

		<div class="chart-card">
			<div class="chart-title">üìã Scan Results</div>
			
			<div style="margin-bottom: 15px; display: flex; gap: 20px; font-size: 18px; color: blue;">
				<a href="#" onclick="reloadEntry('*sdcard*log', true)">/sdcard/log</a>
				<a href="#" onclick="reloadEntry('*littlefs', true)">/littleFS</a>
				<a href="#" onclick="reloadNVS()">/nvs</a>
			</div>

			<div id="list-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; 
							border-radius: 8px; padding: 10px; margin-bottom: 15px; background: lightgray;">
			</div>
			
			<div id="item-container" style="display: flex; justify-content: space-between; margin-bottom: 15px;"></div>
			<div id="button-container" style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;"></div>
			<div id="field-modal" class="w3-modal"></div>
		</div>
	</div>

	<!-- scripts -->
	<script src="../scripts/SharedScript.js"></script>
	<script src="../scripts/RequestServices.js"></script>
	<script src="page-script.js"></script>

	<script>
		function showEraseNSV() {
			show_field_modal('Erase Namespace', '', `
					<button onclick="onEraseNSV()" class="w3-button w3-red w3-round" style="flex: 1;">
						Delete
					</button>
					
					<button onclick="close_field_modal()" class="w3-button w3-gray w3-round" style="flex: 1;">
						Cancel
					</button>
				`)
		}

		function showNVSForm(namespace = '', key, value, type) {
			const is_create = namespace.length < 1

			let type_options = '<option value="">-- Please select --</option>'
			Object.entries(nvs_type_map).forEach(([key, value]) => {
				// skip blob and any
				if (key == 255 || key == 66) return
				const selected = (type == key) ? 'selected' : ''
				type_options += `<option value="${key}" ${selected}>${value}</option>`
			})

			document.getElementById('field-modal').innerHTML = /*html*/
				`<div class="w3-modal-content w3-container" style="max-width: 400px;">
					<h2>${is_create ? 'Create New Key Pair' : `Edit Key Pair`}</h2>

					<!-- Namespace input -->
					<div style="margin-bottom: 20px;">
						<label><b>Namespace:</b></label>
						<input type="text" id="field1-value" value="${namespace ?? ''}" class="w3-input w3-border" 
								style="margin-top: 5px;" maxlength="10">
					</div>

					<!-- Type select -->
					<div style="margin-bottom: 20px;">
						<label><b>Type:</b></label>
						<select id="select-value" class="w3-select w3-border" style="margin-top: 5px;">
							${type_options}
						</select>
					</div>

					<!-- Key input -->
					<div style="margin-bottom: 20px;">
						<label><b>Key:</b></label>
						<input type="text" id="field2-value" value="${key ?? ''}" class="w3-input w3-border" 
								style="margin-top: 5px;" maxlength="10">
					</div>

					<!-- Value input -->
					<div style="margin-bottom: 20px;">
						<label><b>Value:</b></label>
						<input type="text" id="field3-value" value="${value ?? ''}" class="w3-input w3-border"
								style="margin-top: 5px;" maxlength="16">
					</div>

					<!-- Action buttons -->
					<div style="display: flex; gap: 10px; margin-top: 25px; margin-bottom: 15px;">
						<button onclick="onUpdateNVS('${namespace}', '${key}')" class="w3-button w3-blue w3-round" style="flex: 1;">
							${is_create ? 'Create' : 'Update'}
						</button>
						${
							!is_create ?
								`<button onclick="onEraseNSV('${key}')" class="w3-button w3-red w3-round" style="flex: 1;">
									Delete
								</button>`: ''
						}
						
						<button onclick="close_field_modal()" class="w3-button w3-gray w3-round" style="flex: 1;">
							Cancel
						</button>
					</div>
				</div>`

			if (!is_create) {
				document.getElementById('field1-value').readOnly = true
				document.getElementById('field1-value').classList.add('w3-light-gray')
				document.getElementById('select-value').disabled = true
				document.getElementById('select-value').classList.add('w3-light-gray')
			}

			document.getElementById('field-modal').style.display = 'block'
		}

		// Initialize on page load
		window.addEventListener('DOMContentLoaded', async function() {
			reloadEntry()
		})
	</script>
</body>
</html>