<!DOCTYPE html>
<html>
<head>
	<title>ESP32 Sensors Scanner</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../lib/uplot/dist/uPlot.min.css">
	<link rel="stylesheet" href="sensors-scan-style.css">
</head>
<body>
	<div class="dashboard">
		<div class="header">
			<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
				<a href="../sensors/sensors.html">
					<button style="padding: 8px 12px; background: #f0f0f0; border: none; 
									border-radius: 6px; cursor: pointer;">
						‚Üê Back
					</button>
				</a>
				<h1 style="margin: 0;"> üîÑ sensors Scanner</h1>
			</div>

			<p>Scan for sensors</p>
			
			<div class="status-bar">
				<div class="status-item">
					<div>ESP32 IP</div>
					<div id="espIp">Connecting...</div>
				</div>
				<div class="status-item">
					<div>Scan</div>
					<div id="scan-count">---</div>
				</div>
			</div>
			
			<div class="input-group">
				<input type="text" id="serverIp" placeholder="ESP32 IP Address" value="10.0.0.188">
				<button class="btn" onclick="connectToServer()">Connect</button>
			</div>
		</div>

		<div id="charts-container" style="width: 100%;"></div>

		<div class="chart-card">
			<div class="chart-title">üìã Scan Results</div>
			
			<div style="margin-bottom: 15px; display: flex; gap: 10px;">
				<button class="btn" onclick="startScan()">
					üîç Scan Now
				</button>
				<button onclick="clearDevices()" style="padding: 8px 15px; background: #f44336; 
											color: white; border: none; border-radius: 6px; cursor: pointer;">
					üóëÔ∏è Clear
				</button>
			</div>
			
			<div id="devicesList" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; 
									border-radius: 8px; padding: 10px; margin-bottom: 15px; background: lightgray;">
				<div style="text-align: center; padding: 20px; color: #666;">
					No devices found
				</div>
			</div>
			
			<div id="devInfos-container" style="display: flex; justify-content: space-between; margin-bottom: 15px;"></div>

		</div>
	</div>

	<!-- scripts -->
	<script src="../lib/RequestScheduler.js"></script>
	<script>
		// Initialize on page load
		window.addEventListener('DOMContentLoaded', async function() {
			startScan()
		});

		async function startScan() {
			const serverIp = get_serverIp()
			if (!serverIp) return

			const params = new URLSearchParams({
				dev: "aa"		
			})

			scheduler.add(async () => {
				try {
					// Load config
					const resp = await fetch(`http://${serverIp}/scan?${params.toString()}`, {
						method: 'GET'
					})

					if (resp.ok) {
						const result = await resp.json()
						console.log('%cresult:', 'color: red', result)
						updateDeviceList(result.caches, result.cfgs)
					} else {
						const errorText = await resp.text()
						console.error('Server error:', errorText)
					}
				}
				catch(error) {
					console.error('Connection error:', error)
				}
			})
		}

		let devices = []

		function updateDeviceList(device_caches, device_configs) {
			// Mark offline devices (older than 5 minutes)
			const fiveMinutesAgo = Date.now() - 300000
			devices = []
			
			device_caches.forEach(item => {
				const lastSeen = new Date(item[1]*1000);

				devices.push({
					name: 'CH5xx',
					id: item[0],
					lastSeen: lastSeen,
					is_online: lastSeen.getTime() < fiveMinutesAgo,
					is_logged: device_configs.find(cfg => cfg[0] === item[0])
				})
			})
			
			// Update UI
			if (devices.length === 0) {
				document.getElementById('devicesList').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No devices found</div>';
			} else {
				let html = '';
				devices.forEach(device => {
					const timeAgo = Math.round((Date.now() - device.lastSeen.getTime()) / 1000)
					const status_objs = {
						color: device.is_online ? '#4CAF50' : '#f44336',
						text: device.is_online ? 'Online' : 'Offline'
					}
					const logged_objs = {
						color: device.is_logged ? '#4CAF50' : '#f44336',
						text: device.is_logged ? 'Logging' : 'Not Log'
					}
					
					html += /*html*/
						`<div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; gap: 10px;">
							<div style="flex: 1;">
								<div style="font-weight: bold;">${device.id}</div>
								<div style="font-size: 0.8rem; color: #666;">
									${device.name} ‚Ä¢ ${timeAgo}s ago
								</div>
							</div>
							<div onclick="showOptions()" style="background: ${logged_objs.color}; color: white; padding: 3px 8px; border-radius: 10px;">
								${logged_objs.text}
							</div>
							<div style="background: ${status_objs.color}; color: white; padding: 3px 8px; border-radius: 10px;">
								${status_objs.text}
							</div>
						</div>
					`;
				});
				document.getElementById('devicesList').innerHTML = html
			}
			
			// Update counters
			const onlineCount = devices.filter(d => d.is_online);
			document.getElementById('devInfos-container').innerHTML = /*html*/
				`
					<div>Total: <span id="deviceCount">${devices.length}</span></div>
					<div>Online: <span id="onlineCount">${onlineCount}</span></div>
					<div>Last: <span id="lastScan">${(new Date()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>
				`
		}

		function clearDevices() {
			if (devices.length < 1 || !confirm('Clear all devices?')) return
			devices = []
			updateDeviceList([])
		}

		function showOptions() {
			threeButtonAlert('Configure Log',
				{ name: 'Start Log', action: () => { console.log('Start log') } },
				{ name: 'Stop Log', action: () => { console.log('Stop log') } },
				{ name: 'Cancel', action: () => { console.log('Cancel') } },
			)
		}
		
		function closeModal() {
			document.body.removeChild(document.getElementById('overlay-container'));
			window.confirm3 = null;
		}

		function threeButtonAlert(message, option1, option2, option3) {
			if (window.confirm3) return; // Prevent multiple
			const overlay = document.createElement('div');
			overlay.id = 'overlay-container';
			overlay.style.cssText = `
				position: fixed; top: 0; left: 0; width: 100%; height: 100%;
				background: rgba(0,0,0,0.5); z-index: 9999;
				display: flex; align-items: center; justify-content: center;
			`;
			
			const box = document.createElement('div');
			box.style.cssText = `
				background: white; padding: 20px; border-radius: 8px;
				min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
			`;
			
			const msg = document.createElement('div');
			msg.textContent = message;
			msg.style.marginBottom = '20px';
			msg.style.fontSize = '16px';
			box.appendChild(msg);

			// Create buttons
			const createButton = (option, color) => {
				const btn = document.createElement('button');
				btn.textContent = option.name;
				btn.style.cssText = `
					padding: 10px 20px; background: ${color}; 
					color: white; border: none; border-radius: 5px;
					margin: 0 5px; cursor: pointer;
				`;
				btn.onclick = () => {
					document.body.removeChild(overlay);
					window.confirm3 = null;
					option.action(); // Call the action function
				};
				return btn;
			};

			const buttonContainer = document.createElement('div');
			buttonContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
			buttonContainer.appendChild(createButton(option1, '#4CAF50'));
			buttonContainer.appendChild(createButton(option2, '#f44336'));
			buttonContainer.appendChild(createButton(option3, 'lightgray'));
		
			box.appendChild(buttonContainer);
			overlay.appendChild(box);
			document.body.appendChild(overlay);
			window.confirm3 = overlay;
		}
	</script>
</body>
</html>

<!-- 'üü¢' : 'üî¥' -->